{% extends "base.html" %}

{% block title %}Manage Templates{% endblock %}

{% block header_title %}Template Management{% endblock %}

{% block header_actions %}
<div class="btn-group">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTemplateModal">
        <i class="bi bi-plus-circle"></i> New Template
    </button>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="card-title mb-0">Prompt Templates</h5>
                        </div>
                        <div class="col-auto">
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary" id="show-all-btn">All</button>
                                <button class="btn btn-outline-secondary" id="show-project-start-btn">Project Start</button>
                                <button class="btn btn-outline-secondary" id="show-resume-btn">Resume</button>
                                <button class="btn btn-outline-secondary" id="show-worker-dispatch-btn">Worker Dispatch</button>
                                <button class="btn btn-outline-secondary" id="show-custom-btn">Custom</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Dependencies</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="templates-table-body">
                                <!-- Templates will be loaded dynamically -->
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mb-0 mt-2">Loading templates...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Template Confirmation Modal -->
<div class="modal fade" id="deleteTemplateModal" tabindex="-1" aria-labelledby="deleteTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTemplateModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the template <strong id="delete-template-name"></strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let templates = [];
    let currentFilter = 'all';
    
    document.addEventListener('DOMContentLoaded', function() {
        // Load templates
        loadTemplates();
        
        // Set up event handlers for filter buttons
        document.getElementById('show-all-btn').addEventListener('click', function() {
            setActiveFilterButton(this);
            currentFilter = 'all';
            filterTemplates();
        });
        
        document.getElementById('show-project-start-btn').addEventListener('click', function() {
            setActiveFilterButton(this);
            currentFilter = 'project_start';
            filterTemplates();
        });
        
        document.getElementById('show-resume-btn').addEventListener('click', function() {
            setActiveFilterButton(this);
            currentFilter = 'resume';
            filterTemplates();
        });
        
        document.getElementById('show-worker-dispatch-btn').addEventListener('click', function() {
            setActiveFilterButton(this);
            currentFilter = 'worker_dispatch';
            filterTemplates();
        });
        
        document.getElementById('show-custom-btn').addEventListener('click', function() {
            setActiveFilterButton(this);
            currentFilter = 'custom';
            filterTemplates();
        });
        
        // Set active filter button
        function setActiveFilterButton(button) {
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-secondary');
            });
            
            button.classList.remove('btn-outline-secondary');
            button.classList.add('active', 'btn-primary');
        }
        
        // Create template form handler
        document.getElementById('createTemplateBtn').addEventListener('click', createTemplate);
        
        // Delete template confirmation
        document.getElementById('confirm-delete-btn').addEventListener('click', function() {
            const templateId = this.dataset.templateId;
            deleteTemplate(templateId);
        });
    });
    
    function loadTemplates() {
        const tableBody = document.getElementById('templates-table-body');
        
        // Show loading indicator
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mb-0 mt-2">Loading templates...</p>
                </td>
            </tr>
        `;
        
        fetch('/api/prompts/templates')
            .then(response => response.json())
            .then(data => {
                templates = data;
                filterTemplates();
            })
            .catch(error => {
                console.error('Error loading templates:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-danger">
                            <i class="bi bi-exclamation-circle fs-4"></i>
                            <p class="mb-0 mt-2">Error loading templates. Please try again.</p>
                        </td>
                    </tr>
                `;
            });
    }
    
    function filterTemplates() {
        const tableBody = document.getElementById('templates-table-body');
        
        // Filter templates based on current filter
        let filteredTemplates = templates;
        
        if (currentFilter !== 'all') {
            filteredTemplates = filteredTemplates.filter(template => 
                template.type === currentFilter
            );
        }
        
        // Sort by name
        filteredTemplates.sort((a, b) => a.name.localeCompare(b.name));
        
        // Clear table
        tableBody.innerHTML = '';
        
        // Check if no templates
        if (filteredTemplates.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <p class="mb-0">No templates found.</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Add templates to table
        filteredTemplates.forEach(template => {
            const row = document.createElement('tr');
            
            // Name cell
            const nameCell = document.createElement('td');
            const nameLink = document.createElement('a');
            nameLink.href = `/templates/${template.id}`;
            nameLink.textContent = template.name;
            nameCell.appendChild(nameLink);
            
            // Type cell
            const typeCell = document.createElement('td');
            const typeBadge = document.createElement('span');
            typeBadge.className = getTypeClass(template.type);
            typeBadge.textContent = getTypeLabel(template.type);
            typeCell.appendChild(typeBadge);
            
            // Description cell
            const descCell = document.createElement('td');
            descCell.textContent = template.description || '';
            
            // Dependencies cell
            const depsCell = document.createElement('td');
            if (template.fragment_dependencies && template.fragment_dependencies.length > 0) {
                const count = template.fragment_dependencies.length;
                const badge = document.createElement('span');
                badge.className = 'badge bg-info';
                badge.textContent = `${count} fragment${count !== 1 ? 's' : ''}`;
                badge.title = Array.from(template.fragment_dependencies).join(', ');
                depsCell.appendChild(badge);
            } else {
                depsCell.textContent = 'None';
            }
            
            // Updated cell
            const updatedCell = document.createElement('td');
            updatedCell.textContent = dayjs(template.updated_at).fromNow();
            
            // Actions cell
            const actionsCell = document.createElement('td');
            
            // Edit button
            const editBtn = document.createElement('a');
            editBtn.href = `/templates/${template.id}`;
            editBtn.className = 'btn btn-sm btn-outline-primary me-1';
            editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
            editBtn.title = 'Edit';
            
            // Render button
            const renderBtn = document.createElement('a');
            renderBtn.href = `/templates/${template.id}#rendered-pane`;
            renderBtn.className = 'btn btn-sm btn-outline-secondary me-1';
            renderBtn.innerHTML = '<i class="bi bi-gear"></i>';
            renderBtn.title = 'Render';
            
            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-sm btn-outline-danger';
            deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
            deleteBtn.title = 'Delete';
            deleteBtn.addEventListener('click', function() {
                showDeleteConfirmation(template.id, template.name);
            });
            
            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(renderBtn);
            actionsCell.appendChild(deleteBtn);
            
            // Add cells to row
            row.appendChild(nameCell);
            row.appendChild(typeCell);
            row.appendChild(descCell);
            row.appendChild(depsCell);
            row.appendChild(updatedCell);
            row.appendChild(actionsCell);
            
            tableBody.appendChild(row);
        });
    }
    
    function getTypeClass(type) {
        switch (type) {
            case 'project_start':
                return 'badge bg-primary';
            case 'resume':
                return 'badge bg-success';
            case 'worker_dispatch':
                return 'badge bg-warning';
            case 'custom':
            default:
                return 'badge bg-secondary';
        }
    }
    
    function getTypeLabel(type) {
        switch (type) {
            case 'project_start':
                return 'Project Start';
            case 'resume':
                return 'Resume';
            case 'worker_dispatch':
                return 'Worker Dispatch';
            case 'custom':
            default:
                return 'Custom';
        }
    }
    
    function createTemplate() {
        const name = document.getElementById('templateName').value.trim();
        const type = document.getElementById('templateType').value;
        const description = document.getElementById('templateDescription').value.trim();
        
        // Validate
        if (!name) {
            alert('Template name is required');
            return;
        }
        
        // Create template data
        const templateData = {
            name: name,
            type: type,
            description: description,
            content: `# ${name}\n\nEnter template content here...\n\n## Include fragments with this syntax:\n\n[[fragment_id]]`
        };
        
        // Send POST request
        fetch('/api/prompts/templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(templateData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to create template');
            }
            return response.json();
        })
        .then(data => {
            // Success - reload templates and show toast
            loadTemplates();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('newTemplateModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('templateName').value = '';
            document.getElementById('templateDescription').value = '';
            document.getElementById('templateType').value = 'custom';
            
            // Show toast
            showToast('Template created successfully');
            
            // Redirect to edit page
            window.location.href = `/templates/${data.id}`;
        })
        .catch(error => {
            console.error('Error creating template:', error);
            alert('Error creating template. Please try again.');
        });
    }
    
    function showDeleteConfirmation(templateId, templateName) {
        document.getElementById('delete-template-name').textContent = templateName;
        document.getElementById('confirm-delete-btn').dataset.templateId = templateId;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteTemplateModal'));
        deleteModal.show();
    }
    
    function deleteTemplate(templateId) {
        // Send DELETE request
        fetch(`/api/prompts/templates/${templateId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete template');
            }
            return response.json();
        })
        .then(data => {
            // Success - reload templates and show toast
            loadTemplates();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteTemplateModal'));
            modal.hide();
            
            // Show toast
            showToast('Template deleted successfully');
        })
        .catch(error => {
            console.error('Error deleting template:', error);
            alert('Error deleting template. Please try again.');
        });
    }
    
    function showToast(message) {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Notification</strong>
                    <small>Just now</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Initialize and show the toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
        toast.show();
        
        // Remove toast after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
</script>
{% endblock %}
